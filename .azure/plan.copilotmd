# Azure Deployment Plan for DataAssist-poc Project

## **Goal**
Deploy a Streamlit-based Data Assistant application with Azure OpenAI and Elasticsearch integration to Azure Container Apps using Azure Developer CLI (azd).

## **Project Information**
**AppName**: DataAssist-poc
- **Technology Stack**: Python 3.x with Streamlit web framework
- **Application Type**: AI-powered Q&A assistant with RAG (Retrieval Augmented Generation) capabilities
- **Key Features**:
  - Interactive Streamlit web interface with Q&A, Ragas evaluation dashboard, and table explorer
  - Azure OpenAI integration for chat completions and embeddings
  - Elasticsearch integration for document storage and retrieval
  - RLHF (Reinforcement Learning from Human Feedback) implementation
  - Comprehensive logging and analytics capabilities
- **Dependencies**: Azure OpenAI service, Elasticsearch cluster, various Python libraries
- **Hosting Recommendation**: Azure Container Apps for scalable, serverless container hosting

## **Azure Resources Architecture**
> **Install the mermaid extension in IDE to view the architecture.**

```mermaid
graph TB
    User[User] --> CAE[Container App Environment]
    CAE --> CA[DataAssist Container App]
    CA --> ACR[Azure Container Registry]
    CA --> AOA[Azure OpenAI Account]
    CA --> ES[Elasticsearch Service]
    CA --> KV[Azure Key Vault]
    CA --> LAW[Log Analytics Workspace]
    CA --> AI[Application Insights]
    
    subgraph "Azure Container Apps Environment"
        CA
    end
    
    subgraph "External Dependencies"
        ES
    end
    
    subgraph "Azure AI Services"
        AOA
    end
    
    subgraph "Security & Monitoring"
        KV
        LAW
        AI
    end
```

**Data Flow**:
- Users access the Streamlit application through the Container App public endpoint
- The Container App retrieves its Docker image from Azure Container Registry
- The application connects to Azure OpenAI for chat completions and text embeddings
- Document storage and retrieval operations are performed against the Elasticsearch cluster
- Application secrets are securely stored in Azure Key Vault
- All telemetry and logs are sent to Log Analytics Workspace and Application Insights

## **Recommended Azure Resources**

**Application Hosting**
- **Application**: DataAssist-poc
  - **Hosting Service Type**: Azure Container Apps
  - **SKU**: Consumption Plan (0.5 vCPU, 1 GiB memory) - suitable for development/testing workloads
  - **Configuration**:
    - Language: Python 3.11
    - dockerFilePath: ./Dockerfile
    - dockerContext: .
    - Environment Variables:
      - `AZURE_OPENAI_API_KEY` (from Key Vault)
      - `AZURE_OPENAI_ENDPOINT` (from Key Vault)
      - `AZURE_OPENAI_API_VERSION`
      - `AZURE_OPENAI_CHAT_DEPLOYMENT`
      - `AZURE_OPENAI_EMBED_DEPLOYMENT`
      - `ES_URL` (external Elasticsearch endpoint)
      - `ES_INDEX`
  - **Dependencies**:
    - **Azure OpenAI**
      - SKU: Standard S0
      - Service Type: Azure OpenAI
      - Connection Type: API Key (via Key Vault)
      - Environment Variables: `AZURE_OPENAI_API_KEY`, `AZURE_OPENAI_ENDPOINT`
    - **External Elasticsearch**
      - Service Type: External/Self-hosted Elasticsearch
      - Connection Type: HTTP connection string
      - Environment Variables: `ES_URL`, `ES_INDEX`

**Supporting Services**
- **Azure Container Registry**: For storing application container images
- **Application Insights**: Application performance monitoring and diagnostics
- **Log Analytics Workspace**: Centralized logging for all Container Apps
- **Key Vault**: Secure storage for Azure OpenAI API keys and connection strings
- **User-Assigned Managed Identity**: For secure access to Azure resources

**Security Configurations**
- **User-Assigned Managed Identity**: Must be assigned to the container app
- **AcrPull Role Assignment**: Managed identity must have AcrPull role assigned to the container registry
- **Key Vault Access Policy**: Container app identity needs "Get" permission for secrets
- **Network Security**: Container App configured with ingress for external access

## **Execution Steps**
> **Below are the steps to follow for deployment:**

### 1. Provision Azure Infrastructure And Deploy the Application:
1. **Generate Infrastructure as Code (Bicep)**:
   - Create `main.bicep` for all required Azure resources
   - Create `main.parameters.json` with environment-specific parameters
   - Include Container App Environment, Container App, Container Registry, Key Vault, and monitoring resources

2. **Create Application Configuration**:
   - Generate `azure.yaml` for Azure Developer CLI configuration
   - Create `Dockerfile` for containerizing the Streamlit application
   - Generate `requirements.txt` with all Python dependencies

3. **Pre-deployment Validation**:
   - Use `get_errors` tool to validate Bicep syntax
   - Fix any identified errors before deployment

4. **Deploy with Azure Developer CLI**:
   - Run `azd up` to provision resources and deploy application
   - Verify each resource is created successfully
   - Confirm application deployment completes

5. **Post-deployment Verification**:
   - Check deployment outputs for resource endpoints
   - Use `azd-app-log-get` tool to verify application startup
   - Test application endpoints and functionality

### 2. Summary:
1. **Document Deployment Results**:
   - Create `.azure/summary.copilotmd` with deployment summary
   - List all created deployment files with descriptions
   - Include architecture diagram of provisioned Azure resources
   - Provide access instructions and next steps
